<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitForge | Tableau de Bord</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/7Gn3toV.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* Configuration de la police Inter */
        body { font-family: 'Inter', sans-serif; }
        
        /* Transition pour un effet doux des couleurs */
        .transition-colors-theme { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        /* Variables de Thème (Doit être identique à profile.html) */
        .light {
            --bg-page-var: #FFFFFF;
            --bg-header-var: #F6F8FA;
            --bg-card-var: #FFFFFF;
            --bg-active-var: #F3F4F6;
            --border-color-var: #D0D7DE;
            --color-var: #24292F;
            --secondary-var: #57606A;
            --link-var: #0969DA;
            --link-hover-var: #0550B9;
            --primary-button-bg-var: #2DA44E;
            --primary-button-hover-bg-var: #2C974B;
            --primary-button-text-var: #FFFFFF;
            --error-color-var: #CF222E;
            --success-color-var: #1A7F37;
            
            /* Spécifiques au Dashboard/Sidebar */
            --bg-sidebar-var: #F6F8FA;
            --border-sidebar-var: #D0D7DE;
            --bg-sidebar-active-var: #EAECEF;
        }

        /* Application des variables */
        body {
            background-color: var(--bg-page-var);
            color: var(--color-var);
        }
        .text-color-var { color: var(--color-var); }
        .bg-page-var { background-color: var(--bg-page-var); }
        .bg-header-var { background-color: var(--bg-header-var); }
        .bg-card-var { background-color: var(--bg-card-var); }
        .bg-active-var { background-color: var(--bg-active-var); }
        .border-color-var { border-color: var(--border-color-var); }
        .text-secondary-var { color: var(--secondary-var); }
        .text-link-var { color: var(--link-var); }
        .hover\:text-link-hover-var:hover { color: var(--link-hover-var); }
        
        /* Styles spécifiques au Dashboard */
        .bg-sidebar-var { background-color: var(--bg-sidebar-var); }
        .border-sidebar-var { border-color: var(--border-sidebar-var); }
        .bg-sidebar-active-var { background-color: var(--bg-sidebar-active-var); }
        
        /* Styles supplémentaires pour l'esthétique et la réactivité */
        .shadow-md-custom { box-shadow: 0 1px 3px rgba(27,31,35,.15), 0 0 0 1px rgba(27,31,35,.04); }
    </style>
</head>

<body class="flex flex-col min-h-screen transition-colors-theme">

    <!-- En-tête de navigation -->
    <header class="w-full bg-header-var border-b border-color-var transition-colors-theme">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <a href="#" class="flex items-center space-x-2">
                    <img src="https://i.imgur.com/7Gn3toV.png" alt="GitForge Logo" class="h-6 w-auto">
                    <span class="text-xl font-bold text-color-var">GitForge</span>
                </a>

                <!-- Navigation de droite -->
                <nav class="flex items-center space-x-4">
                    <a href="/profile.html" class="text-color-var hover:text-link-hover-var font-medium">Mon Profil</a>
                    <button id="logoutButtonHeader"
                            class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg 
                                   bg-primary-button-var text-primary-button-text-var hover:bg-primary-button-hover-var 
                                   transition duration-150 shadow-md-custom"
                            type="button">
                        Déconnexion
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Contenu Principal avec Sidebar -->
    <div class="flex-grow flex transition-colors-theme max-w-7xl mx-auto w-full">
        
        <!-- Barre Latérale (Sidebar) -->
        <div class="w-64 min-h-full bg-sidebar-var border-r border-sidebar-var flex flex-col pt-8 px-4 transition-colors-theme">
            
            <!-- Liens de Navigation -->
            <nav class="space-y-2 flex-grow">
                <a href="/dashboard.html" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg bg-sidebar-active-var text-color-var transition-colors-theme">
                    <span class="material-symbols-rounded mr-2">home</span>
                    Tableau de Bord
                </a>
                <a href="/repositories.html" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg text-secondary-var hover:bg-active-var transition-colors-theme">
                    <span class="material-symbols-rounded mr-2">folder</span>
                    Dépôts
                </a>
                <a href="/deployments.html" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg text-secondary-var hover:bg-active-var transition-colors-theme">
                    <span class="material-symbols-rounded mr-2">rocket_launch</span>
                    Déploiements
                </a>
                <a href="/settings.html" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg text-secondary-var hover:bg-active-var transition-colors-theme">
                    <span class="material-symbols-rounded mr-2">settings</span>
                    Paramètres
                </a>
            </nav>

            <!-- NOUVELLE SECTION : Informations de l'utilisateur -->
            <!-- Le conteneur doit être à l'intérieur de la sidebar (div.w-64) -->
            <div id="userInfoSection" class="mt-auto pt-4 text-xs text-secondary-var transition-colors-theme border-t border-sidebar-var/50 shrink-0">
                <p>Connecté en tant que: <span id="userEmail" class="font-semibold text-color-var transition-colors-theme">Chargement...</span></p>
                <p>Plan: <span id="userPlan" class="font-semibold text-color-var transition-colors-theme">Chargement...</span></p>
            </div>
            
            <button id="logoutButtonSidebar"
                class="w-full mt-4 mb-4 inline-flex items-center justify-center px-3 py-2 text-sm font-medium rounded-lg 
                       bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md-custom"
                type="button">
                <span class="material-symbols-rounded mr-2 text-base">logout</span>
                Déconnexion
            </button>

        </div>

        <!-- Contenu Principal du Tableau de Bord -->
        <main class="flex-grow p-8">
            <h1 class="text-3xl font-bold mb-8 text-color-var">Bienvenue sur votre Tableau de Bord !</h1>

            <!-- Message de Bienvenue / Prochaines Étapes -->
            <div class="bg-card-var border border-color-var rounded-xl shadow-md-custom p-6 mb-8">
                <h2 class="text-xl font-semibold mb-3 text-color-var">Que souhaitez-vous faire aujourd'hui ?</h2>
                <p class="text-secondary-var mb-4">
                    Commencez par créer votre premier dépôt GitForge pour héberger votre code ou vos applications statiques.
                </p>
                <button 
                    class="inline-flex items-center px-4 py-2 text-base font-medium rounded-lg 
                           bg-primary-button-var text-primary-button-text-var hover:bg-primary-button-hover-var 
                           transition duration-150 shadow-md-custom"
                    onclick="window.location.href='/new-repository.html'">
                    <span class="material-symbols-rounded mr-2">add</span>
                    Nouveau Dépôt
                </button>
            </div>

            <!-- Section "Vos Dépôts Récents" -->
            <h2 class="text-2xl font-semibold mb-4 text-color-var">Vos Dépôts Récents</h2>
            
            <!-- Message de chargement -->
            <div id="loadingMessage" class="flex items-center text-secondary-var p-4 border border-color-var rounded-lg">
                <span class="material-symbols-rounded mr-3 animate-spin">sync</span>
                Chargement des dépôts...
            </div>
            
            <!-- Message si aucun dépôt -->
            <div id="noReposMessage" class="hidden text-secondary-var p-6 border border-color-var rounded-xl bg-card-var text-center">
                <p class="mb-4">Vous n'avez pas encore de dépôts. Créez-en un pour commencer.</p>
                <button 
                    class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg 
                           bg-link-var text-primary-button-text-var hover:bg-link-hover-var 
                           transition duration-150 shadow-md-custom"
                    onclick="window.location.href='/new-repository.html'">
                    Créer mon premier dépôt
                </button>
            </div>

            <!-- Liste des Dépôts (Exemple statique) -->
            <div id="repositoriesList" class="space-y-4">
                
                <!-- Dépôt 1: Exemple Statique -->
                <div class="repo-item bg-card-var border border-color-var rounded-xl p-4 flex justify-between items-center hover:bg-active-var transition-colors-theme">
                    <div>
                        <a href="/repo-files.html?slug=mailix" class="text-link-var hover:text-link-hover-var font-semibold text-lg transition duration-150">
                            mindus0/mailix
                        </a>
                        <p class="text-sm text-secondary-var">Application statique Mailix (Exemple)</p>
                        <div class="flex items-center text-xs mt-2 space-x-4">
                            <span class="text-secondary-var flex items-center">
                                <span class="material-symbols-rounded mr-1 text-base">lock</span>
                                Privé
                            </span>
                            <span class="text-secondary-var flex items-center">
                                <span class="material-symbols-rounded mr-1 text-base">update</span>
                                Mis à jour 2 heures ago
                            </span>
                        </div>
                    </div>
                    <a href="/repo-files.html?slug=mailix" class="px-3 py-1.5 text-sm font-medium rounded-lg border border-color-var bg-active-var text-color-var hover:bg-page-var transition duration-150">
                        Voir le Code
                    </a>
                </div>

            </div>
            
        </main>
    </div>

    <footer class="mt-auto w-full bg-header-var border-t border-color-var transition-colors-theme py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p class="text-secondary-var mb-2">&copy; 2025 GitForge, Inc.</p>
            <nav class="space-x-4">
                <a href="conditions_utilisation.html" class="text-link-var hover:text-link-hover-var">Conditions d'Utilisation</a>
                <a href="mentions_legales.html" class="text-link-var hover:text-link-hover-var">Mentions Légales</a>
                <a href="politique_confidentialite.html" class="text-link-var hover:text-link-hover-var">Politique de Confidentialité</a>
            </nav>
        </div>
    </footer>

    <script>
        // URL du backend Hugging Face
        const BACKEND_URL = "https://ernestmindres-mailix.hf.space";

        const userEmailSpan = document.getElementById('userEmail');
        const userPlanSpan = document.getElementById('userPlan');
        const logoutButtonHeader = document.getElementById('logoutButtonHeader');
        const logoutButtonSidebar = document.getElementById('logoutButtonSidebar');

        /**
         * Récupère les informations de l'utilisateur et les affiche dans la sidebar.
         */
        async function fetchUserInfoAndDisplay() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/user_info`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                    // Le backend gère l'authentification via les cookies de session
                });

                if (response.status === 401) {
                    // Si non autorisé (session expirée ou non connecté), rediriger immédiatement
                    console.log("Session expirée ou non connecté. Redirection vers la page de connexion.");
                    window.location.href = '/connexion.html';
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    const user = result.user;
                    // Afficher l'email de l'utilisateur (Partie demandée)
                    userEmailSpan.textContent = user.email || 'Non spécifié';
                    
                    // Afficher le plan de l'utilisateur
                    userPlanSpan.textContent = user.plan ? user.plan.toUpperCase() : 'GRATUIT';

                    // S'assurer que les spans sont correctement stylisés si besoin
                    userEmailSpan.classList.remove('text-secondary-var');
                    userEmailSpan.classList.add('text-link-var');
                    userPlanSpan.classList.remove('text-secondary-var');
                    userPlanSpan.classList.add('text-color-var');

                } else {
                    // Si la récupération échoue malgré le statut 200/401 géré
                    userEmailSpan.textContent = 'Erreur...';
                    userPlanSpan.textContent = 'Erreur...';
                    console.error("Échec de la récupération des informations utilisateur:", result.message);
                }

            } catch (error) {
                console.error("Erreur de connexion à l'API de profil:", error);
                // En cas d'erreur réseau, considérer l'utilisateur comme déconnecté
                window.location.href = '/connexion.html';
            }
        }

        /**
         * Gère la déconnexion.
         */
        async function handleLogout() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                // Rediriger vers la page de connexion quoi qu'il arrive
                window.location.href = result.redirect || '/connexion.html';

            } catch (error) {
                console.error("Erreur lors de la déconnexion:", error);
                // En cas d'erreur de réseau, forcer la redirection
                window.location.href = '/connexion.html';
            }
        }

        /**
         * Simule le chargement des dépôts (conserve la logique d'exemple statique).
         */
        function loadUserRepositories() {
            const loadingMessage = document.getElementById('loadingMessage');
            const noReposMessage = document.getElementById('noReposMessage');
            // ... (logique de chargement simulée ici si elle était déjà dans le fichier)
            
            // Simuler la fin du chargement
             setTimeout(() => {
                loadingMessage.classList.add('hidden');
                // Supposons qu'il y a toujours l'exemple statique 'mailix' donc on cache noReposMessage
                noReposMessage.classList.add('hidden');
            }, 500);
        }

        // Événements
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserInfoAndDisplay();
            loadUserRepositories(); 
        });
        
        logoutButtonHeader.addEventListener('click', handleLogout);
        logoutButtonSidebar.addEventListener('click', handleLogout);
    </script>
</body>
</html>
