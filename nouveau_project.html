<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitForge | Créer un Nouveau Dépôt</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/7Gn3toV.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
        /* Configuration de la police Inter et Variables de Thème */
        body { font-family: 'Inter', sans-serif; }
        
        :root {
            --bg-page: #FFFFFF;
            --bg-header: #F6F8FA;
            --bg-card: #FFFFFF;
            --bg-active: #F3F4F6; 
            --border-color: #D0D7DE; 
            --text-color: #24292F; 
            --text-secondary: #57606A;
            --text-link: #0969DA; 
            --primary-color: #2DA44E; /* Bouton Create repository (Vert) */
            --primary-hover: #2C974B; 
            --danger-color: #CF222E;
        }

        /* Styles spécifiques au formulaire */
        .card {
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
        }
        .form-input {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.15s ease-in-out;
        }
        .form-input:focus {
            border-color: var(--text-link);
            outline: none;
            box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3);
        }
        .select-item.active {
            border-color: var(--text-link);
            box-shadow: 0 0 0 1px var(--text-link);
        }
    </style>
</head>
<body class="bg-[var(--bg-page)] text-[var(--text-color)]">

    <header class="bg-[var(--bg-header)] border-b border-[var(--border-color)] p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="material-symbols-rounded text-2xl">code_blocks</span>
                <span class="font-semibold text-lg">GitForge</span>
            </div>
            </div>
    </header>

    <main class="max-w-3xl mx-auto p-8">
        <h1 class="text-2xl font-semibold mb-6 border-b border-[var(--border-color)] pb-3">
            Créer un nouveau dépôt
        </h1>
        
        <form id="new-repository-form" class="space-y-6">

            <div class="card p-4 rounded-md space-y-4">
                <label for="repository-name" class="block text-sm font-medium">Nom du Dépôt <span class="text-red-500">*</span></label>
                <input type="text" id="repository-name" class="form-input" placeholder="Ex: mon-super-projet-web" required>
                <p class="text-sm text-[var(--text-secondary)]">
                    Un nom court et mémorable est recommandé.
                </p>
            </div>

            <div class="card p-4 rounded-md space-y-4">
                <h2 class="text-base font-medium mb-2">Visibilité</h2>
                
                <label class="flex items-start space-x-3 cursor-pointer p-3 card select-item active" data-visibility="Public">
                    <input type="radio" name="visibility" value="Public" checked class="mt-1 w-4 h-4 text-[var(--text-link)] border-gray-300 focus:ring-[var(--text-link)]" required>
                    <div>
                        <span class="flex items-center font-medium">
                            <span class="material-symbols-rounded text-xl mr-1">public</span> Public
                        </span>
                        <p class="text-sm text-[var(--text-secondary)] mt-0.5">
                            Tout le monde peut voir ce dépôt. Vous décidez qui peut commiter.
                        </p>
                    </div>
                </label>

                <label class="flex items-start space-x-3 cursor-pointer p-3 card select-item" data-visibility="Private">
                    <input type="radio" name="visibility" value="Private" class="mt-1 w-4 h-4 text-[var(--text-link)] border-gray-300 focus:ring-[var(--text-link)]">
                    <div>
                        <span class="flex items-center font-medium">
                            <span class="material-symbols-rounded text-xl mr-1">lock</span> Privé
                        </span>
                        <p class="text-sm text-[var(--text-secondary)] mt-0.5">
                            Vous seul (et les collaborateurs que vous ajoutez) pouvez voir ce dépôt.
                        </p>
                    </div>
                </label>
            </div>

            <div class="card p-4 rounded-md space-y-4">
                <h2 class="text-base font-medium mb-2">Initialiser le dépôt (Optionnel)</h2>
                
                <div>
                    <label for="gitignore-search" class="block text-sm font-medium mb-1">Ajouter un fichier .gitignore</label>
                    <input type="text" id="gitignore-search" class="form-input" placeholder="Rechercher une template (ex: Python, Node)">
                    
                    <div id="gitignore-results" class="mt-2 space-y-1 max-h-48 overflow-y-auto card p-2 rounded-md hidden">
                        </div>
                    <div id="no-gitignore-items" class="mt-2 text-sm text-red-500 hidden">
                        Aucun template correspondant trouvé.
                    </div>
                    <p class="mt-2 text-sm text-[var(--text-secondary)]">Template sélectionné: <span id="selected-gitignore" class="font-mono bg-gray-100 p-1 rounded">Aucun</span></p>
                </div>

                <div>
                    <label for="license-select" class="block text-sm font-medium mb-1">Ajouter une license</label>
                    <select id="license-select" class="form-input">
                        <option value="">Aucune</option>
                        <option value="MIT">MIT License</option>
                        <option value="GPL-3.0">GPLv3</option>
                        <option value="Apache-2.0">Apache License 2.0</option>
                        </select>
                    <p class="text-sm text-[var(--text-secondary)] mt-1">
                        Aide à déterminer comment les autres peuvent utiliser votre code.
                    </p>
                </div>
            </div>


            <button id="create-repo-btn" type="submit" class="w-full inline-flex justify-center items-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[var(--primary-color)] text-base font-medium text-white hover:bg-[var(--primary-hover)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-color)] sm:text-sm transition-colors duration-150">
                Créer le dépôt
            </button>
        </form>

    </main>
    
    <footer class="mt-12 border-t border-[var(--border-color)] p-4 text-center text-sm text-[var(--text-secondary)]">
        &copy; 2024 GitForge. Propulsé par Hugging Face et Baserow.
    </footer>

    <script>
        // 1. URL du Backend
        const BACKEND_URL = 'https://ernestmindres-mailix.hf.space';

        // 2. Récupération des éléments du DOM
        const form = document.getElementById('new-repository-form');
        const repoNameInput = document.getElementById('repository-name');
        const createBtn = document.getElementById('create-repo-btn');
        const visibilityRadios = document.querySelectorAll('input[name="visibility"]');
        const visibilityLabels = document.querySelectorAll('.select-item');
        const gitignoreSearch = document.getElementById('gitignore-search');
        const gitignoreResults = document.getElementById('gitignore-results');
        const noGitignoreItems = document.getElementById('no-gitignore-items');
        const selectedGitignoreSpan = document.getElementById('selected-gitignore');
        const licenseSelect = document.getElementById('license-select');

        // 3. Variables d'état (Simulées à partir des inputs)
        let visibility = 'Public';
        let gitignore = '';
        let license = '';

        // 4. Logique du Formulaire (Gestion des changements d'état)
        
        // A. Visibilité
        visibilityRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                visibility = e.target.value;
                visibilityLabels.forEach(label => {
                    label.classList.remove('active');
                });
                document.querySelector(`.select-item[data-visibility="${visibility}"]`).classList.add('active');
            });
        });

        // B. License
        licenseSelect.addEventListener('change', (e) => {
            license = e.target.value;
        });


        // C. .gitignore (Logique de recherche simplifiée pour l'exemple)
        const allGitignoreTemplates = [
            'Python', 'Node', 'Vue', 'React', 'Angular', 'Java', 'C++', 'Unity', 'Django', 'Flask', 
            'Go', 'C#', 'PHP', 'Ruby', 'Swift', 'Objective-C', 'Maven', 'Gradle', 'VSCode'
        ];

        // Fonction pour afficher les résultats de .gitignore
        function renderGitignoreResults(searchText) {
            gitignoreResults.innerHTML = '';
            let itemsFound = 0;
            
            const filtered = allGitignoreTemplates
                .filter(name => name.toLowerCase().includes(searchText.toLowerCase()))
                .sort();
            
            if (filtered.length > 0) {
                gitignoreResults.classList.remove('hidden');
                filtered.forEach(name => {
                    const item = document.createElement('div');
                    item.classList.add('gitignore-item', 'p-2', 'rounded', 'cursor-pointer', 'hover:bg-[var(--bg-active)]', 'text-sm');
                    if (name === gitignore) item.classList.add('font-semibold', 'bg-[var(--bg-active)]');
                    item.textContent = name;
                    item.dataset.value = name;
                    
                    item.addEventListener('click', () => {
                        gitignore = name;
                        selectedGitignoreSpan.textContent = name;
                        gitignoreSearch.value = name;
                        gitignoreResults.classList.add('hidden'); // Cacher après sélection
                        renderGitignoreResults(''); // Optionnel : pour mettre à jour la sélection visuelle
                    });
                    gitignoreResults.appendChild(item);
                    itemsFound++;
                });
            } else {
                gitignoreResults.classList.add('hidden');
            }

            // Afficher le message "No items available"
            if (itemsFound === 0 && searchText.length > 0) {
                noGitignoreItems.classList.remove('hidden');
            } else {
                noGitignoreItems.classList.add('hidden');
            }
        }
        
        // Événement de recherche (Afficher/Filtrer la liste)
        gitignoreSearch.addEventListener('input', (e) => {
            const searchText = e.target.value.trim();
            if (searchText.length > 0) {
                renderGitignoreResults(searchText);
            } else {
                gitignoreResults.classList.add('hidden');
                noGitignoreItems.classList.add('hidden');
            }
        });
        
        // Clic sur l'extérieur pour cacher
        document.addEventListener('click', (e) => {
            if (!gitignoreSearch.contains(e.target) && !gitignoreResults.contains(e.target)) {
                // Si l'utilisateur a sélectionné un template, mettre à jour la valeur de l'input
                if (gitignore) {
                    gitignoreSearch.value = gitignore;
                } else {
                    gitignoreSearch.value = ''; // ou garder vide si rien n'est sélectionné
                }
                gitignoreResults.classList.add('hidden');
                noGitignoreItems.classList.add('hidden');
            }
        });
        
        // Initialisation : permettre de vider le champ
        gitignoreSearch.addEventListener('focus', () => {
             // Si l'utilisateur clique sur le champ, on affiche la liste complète ou vide le champ
             renderGitignoreResults(gitignoreSearch.value);
        });
        
        // Réinitialisation du .gitignore sur vide
        gitignoreSearch.addEventListener('blur', () => {
            // Si le champ est vidé, on réinitialise l'état
            if (gitignoreSearch.value.trim() === '') {
                gitignore = '';
                selectedGitignoreSpan.textContent = 'Aucun';
            }
        });


        // 5. Soumission du Formulaire (Mise à Jour pour le VRAI Backend)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const repoName = repoNameInput.value.trim();

            if (!repoName) {
                alert("Veuillez donner un nom à votre dépôt.");
                return;
            }

            // 1. Préparer les données
            const repoData = {
                repo_name: repoName,
                visibility: visibility, 
                gitignore_template: gitignore, 
                license_template: license
            };

            // 2. Préparer l'interface utilisateur pour l'attente
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="material-symbols-rounded animate-spin">sync</span> Création...';
            createBtn.classList.add('opacity-70');
            
            const API_ENDPOINT = `${BACKEND_URL}/api/create_repository`;

            try {
                // 3. Envoyer la requête au backend
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // ENVOI DU COOKIE DE SESSION pour l'authentification (@login_required)
                    credentials: 'include', 
                    body: JSON.stringify(repoData)
                });

                const result = await response.json();

                // 4. Gérer la réponse
                if (response.ok) {
                    // Succès (statut 201 attendu par le backend) : Récupérer le repo_slug et rediriger
                    const repoSlug = result.repo_slug;
                    console.log(`Dépôt créé avec succès. Slug: ${repoSlug}`);
                    // Redirection vers la page repo_files.html avec le slug du dépôt
                    window.location.href = `repo_files.html?repo_slug=${encodeURIComponent(repoSlug)}&status=created`;
                } else {
                    // Échec (ex: 400 Bad Request, 401 Unauthorized, 409 Conflict)
                    alert(`Erreur lors de la création du dépôt : ${result.message || 'Erreur inconnue du serveur.'}`);
                }

            } catch (error) {
                // Erreur réseau ou de parsing (par ex. si le backend est injoignable)
                console.error("Erreur Fetch:", error);
                alert("Erreur réseau. Le backend est peut-être injoignable. Veuillez vérifier l'URL ou réessayer.");
            } finally {
                // Rétablir l'interface utilisateur
                createBtn.disabled = false;
                createBtn.innerHTML = 'Créer le dépôt';
                createBtn.classList.remove('opacity-70');
            }
        });

        // 6. Logique de Sécurité (Sécuriser l'accès après connexion - Simulé côté client)
        // C'est ici que vous pourriez vérifier l'existence d'un cookie de session
        // ou appeler un endpoint de vérification (`/api/me`) pour s'assurer que l'utilisateur est connecté.
        // Si non connecté, rediriger vers la page de connexion.
        // Exemple simple : on suppose que la page est inaccessible sans une session active.

    </script>
</body>
</html>
